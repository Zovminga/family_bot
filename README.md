# Family Bot - Telegram бот для учета семейных расходов

Telegram бот для ведения учета семейных расходов с интеграцией Google Sheets.

## Возможности

- ✅ Добавление трат по категориям
- ✅ Выбор валюты (RUB, RSD, EUR)
- ✅ Указание кто внес трату
- ✅ Добавление комментариев
- ✅ Статистика по месяцам и категориям
- ✅ Группировка статистики по категориям с процентами
- ✅ Автоматическое определение пользователей по Telegram (без лишних выборов)
- ✅ Интеграция с Google Sheets
- ✅ Динамическая загрузка категорий из Google Sheets

## Команды бота

- `/start` - запуск бота
- `/categories` - показать текущие категории
- `/reloadcats` - перезагрузить категории из Google Sheets
- `/test_connection` - протестировать подключение к Google Sheets
- `/whoami` - показать информацию о профиле
- `/register ИМЯ` - зарегистрировать пользователя
- `/cancel` или `/stop` - отменить текущее действие

## Настройка

### 1. Переменные окружения

Создайте файл `.env` или установите переменные окружения:

```bash
BOT_TOKEN=your_telegram_bot_token
GOOGLE_CREDS_PATH=/path/to/your/credentials.json
SHEET_NAME=your_google_sheet_name
RENDER_EXTERNAL_URL=https://your-app.onrender.com  # для деплоя на Render
```

### 2. Google Sheets настройка

1. Создайте Google Sheets таблицу
2. Создайте лист "Config" для категорий
3. В столбце A листа Config добавьте категории:
   ```
   A1: Категории
   A2: Продукты
   A3: Транспорт
   A4: Развлечения
   A5: Рестораны
   A6: Покупки
   A7: Здоровье
   A8: Другое
   ```
4. Создайте лист "Data" для хранения трат
5. Настройте права доступа для сервисного аккаунта

### 3. Google Cloud настройка

1. Создайте проект в Google Cloud Console
2. Включите Google Sheets API
3. Создайте сервисный аккаунт
4. Скачайте JSON файл с credentials
5. Предоставьте доступ к таблице для email сервисного аккаунта

## Установка и запуск

### Локальная разработка

```bash
# Клонируйте репозиторий
git clone <repository-url>
cd family_bot

# Создайте виртуальное окружение
python -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate  # Windows

# Установите зависимости
pip install -r requirements.txt

# Настройте переменные окружения
export BOT_TOKEN=your_token
export GOOGLE_CREDS_PATH=/path/to/credentials.json
export SHEET_NAME=your_sheet_name

# Запустите бота
python bot.py
```

### Тестирование подключения

```bash
python test_google_sheets.py
```

### Деплой на Render

1. Подключите репозиторий к Render
2. Настройте переменные окружения в Render Dashboard
3. Укажите команду запуска: `python bot.py`
4. Укажите порт: `8443`

## Структура Google Sheets

### Лист "Config"
- Столбец A: категории трат

### Лист "Data"
- Дата (дд.мм.гггг)
- Месяц (гггг-мм)
- Категория
- Сумма
- Валюта
- Кто внес
- Комментарий

## Устранение неполадок

### Категории не загружаются
1. Проверьте название листа "Config"
2. Убедитесь, что в столбце A есть данные
3. Используйте команду `/test_connection`

### Ошибка подключения к Google Sheets
1. Проверьте путь к файлу credentials
2. Убедитесь, что сервисный аккаунт имеет доступ к таблице
3. Проверьте название таблицы в переменной SHEET_NAME

### Бот не отвечает
1. Проверьте токен бота
2. Убедитесь, что бот запущен
3. Проверьте логи в консоли

## Разработка

### Добавление новых функций

1. Создайте новую функцию-обработчик
2. Добавьте обработчик в ConversationHandler
3. Обновите состояния диалога при необходимости

### Структура кода

- `bot.py` - основной файл бота
- `test_google_sheets.py` - скрипт для тестирования
- `requirements.txt` - зависимости
- `GOOGLE_SHEETS_SETUP.md` - инструкции по настройке Google Sheets

## Лицензия

MIT License
